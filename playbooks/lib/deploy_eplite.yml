- hosts: all

  vars:
    require:
      packages:
        - python-docker-py
    epmysql:
      device: /dev/vdb
      dir: /data
      image: "enakai00/epmysql:ver1.0"
      ports:
        - "3306:3306"
      volumes: "/data:/var/lib/mysql"
      expose:
        - 3306
    eplite:
      image: "enakai00/eplite:ver1.0"
      ports:
        - "80:80"
      expose:
        - 80
      env:
        FIP: "{{ ansible_ssh_hosts.eplite[0] }}"
        DB_PORT_3306_TCP_ADDR: "{{ ansible_ssh_hosts.epmysql[0] }}"

  tasks:
    - name: install require packages
      yum:
        state: latest
        name: "{{ item }}"
      with_items: "{{ require.packages }}"
      sudo: yes

    - name: start epmysql
      docker:
        state: started
        name: epmysql
        image: "{{ epmysql.image }}"
        ports: "{{ epmysql.ports }}"
        expose: "{{ epmysql.expose }}"
        volumes: "{{ epmysql.volumes }}"
        tty: True
      sudo: yes
      when: ansible_hostname == "epmysql"

    - name: start eplite
      docker:
        state: started
        name: eplite
        image: "{{ eplite.image }}"
        ports: "{{ eplite.ports }}"
        expose: "{{ eplite.expose }}"
        env: "{{ eplite.env }}"
        tty: True
      sudo: yes
      when: ansible_hostname == "eplite"
